<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ã‚¹ãƒãƒ›ã§ä½œã‚Œã‚‹ï¼ç§’é€Ÿãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸å·¥æˆ¿ v2</title>
<style>
/* =========================================
   Global Reset & UI Variables
   ========================================= */
:root {
    /* Dimensions */
    --header-h: 60px;
    --footer-h: 40px;
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    
    /* Shadows */
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
    --shadow-float: 0 10px 25px -5px rgba(0,0,0,0.15);

    /* Light Theme (Default) */
    --ui-primary: #020562;
    --ui-accent: #22AEC9;
    --ui-bg: #F8FAFC;
    --ui-surface: #FFFFFF;
    --ui-text: #334155;
    --ui-text-muted: #64748B;
    --ui-border: #E2E8F0;
    --ui-danger: #EF4444;
    --ui-header-bg: #FFFFFF;
}

[data-theme="dark"] {
    --ui-primary: #818cf8;
    --ui-accent: #38bdf8;
    --ui-bg: #0f172a;
    --ui-surface: #1e293b;
    --ui-text: #f1f5f9;
    --ui-text-muted: #94a3b8;
    --ui-border: #334155;
    --ui-header-bg: #1e293b;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
    margin: 0; padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--ui-bg);
    color: var(--ui-text);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

/* =========================================
   App Layout
   ========================================= */
.app-header {
    height: var(--header-h);
    background: var(--ui-header-bg);
    border-bottom: 1px solid var(--ui-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    z-index: 50;
    flex-shrink: 0;
}

.app-logo {
    display: flex; align-items: center; gap: 8px;
    font-weight: 800; font-size: 1rem;
    color: var(--ui-text);
}
.app-logo svg { fill: var(--ui-accent); width: 22px; height: 22px; }

.app-actions { display: flex; gap: 8px; }

.app-main {
    flex: 1;
    display: grid;
    grid-template-columns: 420px 1fr; /* Wider editor for better photo UI */
    overflow: hidden;
    height: calc(100vh - var(--header-h) - var(--footer-h));
}

/* Footer */
.app-footer {
    height: var(--footer-h);
    background: var(--ui-header-bg);
    border-top: 1px solid var(--ui-border);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.75rem; color: var(--ui-text-muted);
    flex-shrink: 0; z-index: 50;
}

/* =========================================
   Editor Panel (Left) - NEW PHOTO FIRST UI
   ========================================= */
.editor-panel {
    background: var(--ui-surface);
    border-right: 1px solid var(--ui-border);
    display: flex; flex-direction: column;
    overflow-y: auto;
    position: relative;
    z-index: 10;
}

.step-container {
    padding: 24px;
    padding-bottom: 100px;
    display: flex; flex-direction: column; gap: 32px;
}

/* Step Headers */
.step-header {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 16px;
}
.step-num {
    background: var(--ui-accent); color: #fff;
    width: 24px; height: 24px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-weight: bold; font-size: 0.85rem;
}
.step-title { font-weight: 700; font-size: 1.05rem; color: var(--ui-text); }

/* Compact Inputs */
.compact-grid {
    display: grid; grid-template-columns: 1fr; gap: 12px;
}
.input-row { display: flex; flex-direction: column; gap: 6px; }
.label-sm { font-size: 0.8rem; font-weight: 600; color: var(--ui-text-muted); }
.input-sm {
    padding: 10px; border: 1px solid var(--ui-border);
    border-radius: var(--radius-sm); font-size: 0.95rem;
    background: var(--ui-bg); color: var(--ui-text);
}

/* Theme Color Pills */
.color-pills { display: flex; gap: 8px; }
.color-pill {
    width: 36px; height: 36px; border-radius: 50%;
    cursor: pointer; position: relative;
    border: 2px solid transparent; transition: transform 0.2s;
}
.color-pill.active { border-color: var(--ui-text); transform: scale(1.1); }
.color-pill::after {
    content:''; position:absolute; inset:2px; border-radius:50%; background: var(--bg);
}

/* Photo Puzzle Deck */
.photo-deck {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}
.photo-card {
    background: var(--ui-bg);
    border: 2px dashed var(--ui-border);
    border-radius: var(--radius-md);
    position: relative;
    cursor: pointer;
    overflow: hidden;
    aspect-ratio: 4/3;
    transition: all 0.2s;
}
.photo-card.hero {
    grid-column: 1 / -1; /* Full width */
    aspect-ratio: 16/9;
    border-color: var(--ui-accent);
    background: rgba(34, 174, 201, 0.05);
}
.photo-card:hover { border-color: var(--ui-text-muted); }
.photo-card.has-image { border-style: solid; border-color: transparent; }

/* Photo Card Content */
.photo-placeholder {
    position: absolute; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    color: var(--ui-text-muted);
    pointer-events: none;
    text-align: center; padding: 10px;
}
.photo-placeholder svg { width: 32px; height: 32px; margin-bottom: 8px; opacity: 0.5; }
.photo-label { font-size: 0.8rem; font-weight: 600; margin-bottom: 2px;}
.photo-sub { font-size: 0.7rem; opacity: 0.8; line-height: 1.3; }

.photo-preview {
    width: 100%; height: 100%; object-fit: cover;
    display: none;
}
.photo-card.has-image .photo-preview { display: block; }
.photo-card.has-image .photo-placeholder { display: none; }

/* Clear Button on Photo */
.btn-photo-clear {
    position: absolute; top: 6px; right: 6px;
    width: 24px; height: 24px; border-radius: 50%;
    background: rgba(0,0,0,0.6); color: #fff;
    border: none; display: none;
    align-items: center; justify-content: center;
    font-size: 14px; cursor: pointer;
}
.photo-card.has-image:hover .btn-photo-clear { display: flex; }

/* Collapsible Text Edit */
.text-edit-toggle {
    text-align: center; margin-top: 10px;
}
.btn-text-edit {
    font-size: 0.85rem; color: var(--ui-accent);
    background: none; border: none; cursor: pointer;
    text-decoration: underline;
}
.text-edit-section {
    display: none; background: var(--ui-bg);
    border-radius: var(--radius-md); padding: 16px;
    margin-top: 10px;
}
.text-edit-section.open { display: block; }

/* =========================================
   Preview Panel (Right)
   ========================================= */
.preview-panel {
    background: #1e293b;
    display: flex; flex-direction: column;
    position: relative; overflow: hidden;
}

.preview-toolbar {
    height: 50px; background: rgba(0,0,0,0.3);
    display: flex; align-items: center; justify-content: center; gap: 16px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.device-btn {
    background: transparent; border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.7);
    padding: 6px 12px; border-radius: 20px;
    font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 6px;
}
.device-btn.active {
    background: var(--ui-accent); border-color: var(--ui-accent); color: #fff;
}

.preview-canvas {
    flex: 1; display: flex; justify-content: center; align-items: center;
    overflow: auto; padding: 40px;
}
.preview-frame-wrapper {
    background: #fff; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    transition: all 0.3s;
}
.preview-frame-wrapper.mode-pc { width: 100%; height: 100%; border-radius: 4px; max-width: 1200px; }
.preview-frame-wrapper.mode-mobile { width: 375px; height: 100%; max-height: 750px; border-radius: 24px; border: 10px solid #333; }

iframe { width: 100%; height: 100%; border: none; }

/* Fullscreen Overlay */
.fullscreen-overlay {
    position: fixed; inset: 0; background: #fff; z-index: 1000;
    display: none; flex-direction: column;
}
.fullscreen-overlay.active { display: flex; animation: fadeIn 0.2s; }
#fullscreen-frame { flex: 1; width: 100%; border: none; }
.btn-floating-close {
    position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: #1e293b; color: #fff; padding: 12px 24px;
    border-radius: 50px; border: none; font-weight: bold; cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 8px;
    font-size: 1rem; z-index: 1001; transition: transform 0.2s;
}
.btn-floating-close:active { transform: translateX(-50%) scale(0.95); }

/* Utility & Badges */
.btn {
    padding: 8px 16px; border-radius: var(--radius-sm);
    font-weight: 600; font-size: 0.85rem; cursor: pointer;
    border: 1px solid transparent; display: inline-flex; align-items: center; gap: 6px;
}
.btn-primary { background: var(--ui-primary); color: #fff; }
.btn-ghost { background: transparent; color: var(--ui-text); border-color: var(--ui-border); }
.btn-icon { padding: 8px; border-radius: 50%; color: var(--ui-text); background: transparent; border: none; cursor: pointer; position: relative; }
.btn-icon:hover { background: var(--ui-bg); }

.badge-dot {
    position: absolute; top: 6px; right: 6px;
    width: 8px; height: 8px; background: var(--ui-danger);
    border-radius: 50%; border: 1px solid var(--ui-header-bg);
    display: none;
}
.badge-dot.active { display: block; }

/* Mobile */
@media (max-width: 768px) {
    .app-main { grid-template-columns: 1fr; }
    .preview-panel { display: none; position: fixed; inset: 0; z-index: 100; padding: 0; }
    .preview-panel.active { display: flex; }
    .preview-canvas { padding: 0; background: #fff; }
    .preview-frame-wrapper { width: 100% !important; height: 100% !important; border: none !important; border-radius: 0 !important; }
    .hide-on-mobile { display: none; }
}

/* Modals */
.modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px); z-index: 200;
    display: none; align-items: center; justify-content: center;
}
.modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
.modal-box {
    background: var(--ui-surface); width: 90%; max-width: 450px;
    border-radius: var(--radius-lg); padding: 0;
    box-shadow: var(--shadow-float); overflow: hidden;
    max-height: 90vh; display: flex; flex-direction: column;
}
.modal-header {
    padding: 16px 20px; border-bottom: 1px solid var(--ui-border);
    font-weight: bold; display: flex; justify-content: space-between; align-items: center;
}
.modal-body { padding: 20px; overflow-y: auto; }
.modal-footer {
    padding: 16px 20px; background: var(--ui-bg); border-top: 1px solid var(--ui-border);
    display: flex; justify-content: flex-end;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.toast {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: #1e293b; color: #fff; padding: 10px 24px; border-radius: 30px;
    font-size: 0.9rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 300;
}
.toast.active { opacity: 1; }

</style>
</head>
<body>

<!-- Header -->
<header class="app-header">
    <div class="app-logo">
        <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>
        <span>ç§’é€Ÿãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸å·¥æˆ¿ v2</span>
    </div>
    <div class="app-actions">
        <button class="btn btn-ghost" id="btn-guide">ğŸ”° ä½¿ã„æ–¹</button>
        <button class="btn btn-icon" id="btn-settings" title="è¨­å®š">
            âš™ï¸
            <div class="badge-dot" id="badge-settings"></div>
        </button>
        <button class="btn btn-primary" id="btn-export-html">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            <span class="hide-on-mobile">æ›¸ãå‡ºã—</span>
        </button>
    </div>
</header>

<main class="app-main">
    
    <!-- Editor -->
    <div class="editor-panel">
        <div class="step-container">
            
            <!-- STEP 1: Basic Setup -->
            <div class="step-section">
                <div class="step-header">
                    <div class="step-num">1</div>
                    <div class="step-title">åŸºæœ¬è¨­å®š</div>
                </div>
                <div class="compact-grid">
                    <div class="input-row">
                        <label class="label-sm">æ¥­ç¨®ï¼ˆæ–‡ç« ãƒ»æ§‹æˆãŒè‡ªå‹•ã§å¤‰ã‚ã‚Šã¾ã™ï¼‰</label>
                        <select id="sel-industry" class="input-sm">
                            <option value="manufacturing">è£½é€ æ¥­</option>
                            <option value="wholesale">å¸æ¥­</option>
                            <option value="insurance">ä¿é™ºä»£ç†åº—</option>
                            <option value="renovation">å†…è£…ãƒ»ãƒªãƒ•ã‚©ãƒ¼ãƒ </option>
                            <option value="pro">å£«æ¥­ï¼ˆç¨ç†å£«ãƒ»è¡Œæ”¿æ›¸å£«ï¼‰</option>
                            <option value="consulting">ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ</option>
                            <option value="clinic">æ•´ä½“ãƒ»ã‚¯ãƒªãƒ‹ãƒƒã‚¯</option>
                            <option value="restaurant">é£²é£Ÿåº—ï¼ˆã‚«ãƒ•ã‚§ãƒ»å±…é…’å±‹ï¼‰</option>
                            <option value="salon">ç¾å®¹å®¤ãƒ»ã‚µãƒ­ãƒ³</option>
                        </select>
                    </div>
                    
                    <div class="input-row">
                        <label class="label-sm">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</label>
                        <div class="color-pills" id="color-pills">
                            <!-- JS will populate -->
                        </div>
                    </div>
                    
                    <div style="margin-top:10px;">
                        <button class="btn btn-ghost" onclick="document.getElementById('btn-settings').click()" style="width:100%; border-style:dashed; color:var(--ui-accent);">
                            âœ ä¼šç¤¾åãƒ»SNSã‚’è¨­å®šã™ã‚‹
                        </button>
                    </div>
                </div>
            </div>

            <!-- STEP 2: Photo Puzzle -->
            <div class="step-section">
                <div class="step-header">
                    <div class="step-num">2</div>
                    <div class="step-title">å†™çœŸã‚’é¸ã¶</div>
                </div>
                <p style="font-size:0.85rem; color:var(--ui-text-muted); margin-top:-10px; margin-bottom:12px;">
                    æ ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€ã‚¹ãƒãƒ›ã®å†™çœŸã‚’é¸ã¶ã ã‘ã€‚
                </p>
                
                <div class="photo-deck">
                    <!-- Hero Image -->
                    <div class="photo-card hero" id="card-hero" data-target="hero">
                        <img src="" class="photo-preview" id="img-hero">
                        <div class="photo-placeholder">
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                            <span class="photo-label">ãƒ¡ã‚¤ãƒ³å†™çœŸ</span>
                            <span class="photo-sub" id="hint-hero">ã‚µã‚¤ãƒˆã®é¡”ï¼ˆå¤–è¦³ãƒ»é›†åˆå†™çœŸãªã©ï¼‰</span>
                        </div>
                        <button class="btn-photo-clear" data-target="hero">âœ•</button>
                    </div>

                    <!-- Point 1 -->
                    <div class="photo-card" id="card-p1" data-target="p1">
                        <img src="" class="photo-preview" id="img-p1">
                        <div class="photo-placeholder">
                            <span class="photo-label">ç”»åƒ â‘ </span>
                            <span class="photo-sub" id="lbl-p1"></span>
                        </div>
                        <button class="btn-photo-clear" data-target="p1">âœ•</button>
                    </div>

                    <!-- Point 2 -->
                    <div class="photo-card" id="card-p2" data-target="p2">
                        <img src="" class="photo-preview" id="img-p2">
                        <div class="photo-placeholder">
                            <span class="photo-label">ç”»åƒ â‘¡</span>
                            <span class="photo-sub" id="lbl-p2"></span>
                        </div>
                        <button class="btn-photo-clear" data-target="p2">âœ•</button>
                    </div>

                    <!-- Point 3 -->
                    <div class="photo-card" id="card-p3" data-target="p3">
                        <img src="" class="photo-preview" id="img-p3">
                        <div class="photo-placeholder">
                            <span class="photo-label">ç”»åƒ â‘¢</span>
                            <span class="photo-sub" id="lbl-p3"></span>
                        </div>
                        <button class="btn-photo-clear" data-target="p3">âœ•</button>
                    </div>
                </div>

                <!-- Hidden Text Editor (Advanced) -->
                <div class="text-edit-toggle">
                    <button class="btn-text-edit" id="btn-toggle-text">æ–‡ç« ã‚’å¾®èª¿æ•´ã™ã‚‹ï¼ˆä¸Šç´šè€…å‘ã‘ï¼‰</button>
                </div>
                
                <div class="text-edit-section" id="text-edit-section">
                    <div class="compact-grid">
                        <div class="input-row">
                            <label class="label-sm">ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼</label>
                            <textarea id="inp-catch" class="input-sm" rows="2"></textarea>
                        </div>
                        <div class="input-row">
                            <label class="label-sm">ç‰¹å¾´1 ã‚¿ã‚¤ãƒˆãƒ«</label>
                            <input type="text" id="inp-p1-t" class="input-sm">
                            <label class="label-sm">ç‰¹å¾´1 èª¬æ˜</label>
                            <textarea id="inp-p1-d" class="input-sm" rows="2"></textarea>
                        </div>
                         <div class="input-row">
                            <label class="label-sm">ç‰¹å¾´2 ã‚¿ã‚¤ãƒˆãƒ«</label>
                            <input type="text" id="inp-p2-t" class="input-sm">
                             <label class="label-sm">ç‰¹å¾´2 èª¬æ˜</label>
                            <textarea id="inp-p2-d" class="input-sm" rows="2"></textarea>
                        </div>
                         <div class="input-row">
                            <label class="label-sm">ç‰¹å¾´3 ã‚¿ã‚¤ãƒˆãƒ«</label>
                            <input type="text" id="inp-p3-t" class="input-sm">
                             <label class="label-sm">ç‰¹å¾´3 èª¬æ˜</label>
                            <textarea id="inp-p3-d" class="input-sm" rows="2"></textarea>
                        </div>
                        <div class="input-row">
                            <label class="label-sm">é›»è©±ç•ªå·</label>
                            <input type="text" id="inp-tel" class="input-sm">
                        </div>
                        <div class="input-row">
                            <label class="label-sm">å—ä»˜æ™‚é–“</label>
                            <input type="text" id="inp-hours" class="input-sm">
                        </div>
                    </div>
                </div>

            </div>

        </div>
        
        <!-- Hidden file input -->
        <input type="file" id="file-input" accept="image/*" style="display:none">
    </div>

    <!-- Preview -->
    <div class="preview-panel" id="preview-panel">
        <div class="preview-toolbar">
            <button class="device-btn active" data-mode="pc">PC</button>
            <button class="device-btn" data-mode="mobile">Mobile</button>
            <div style="width:1px; height:20px; background:rgba(255,255,255,0.2); margin:0 8px;"></div>
            <button class="device-btn" id="btn-fullscreen" style="background:var(--ui-accent); color:#fff; border:none;">
                <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24" style="margin-right:4px;"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                å…¨ç”»é¢ã§è¦‹ã‚‹
            </button>
        </div>
        <div class="preview-canvas">
            <div class="preview-frame-wrapper mode-pc" id="preview-wrapper">
                <iframe id="preview-frame"></iframe>
            </div>
        </div>
        <button id="btn-close-preview" class="btn btn-primary" style="position:fixed; bottom:20px; right:20px; display:none; z-index:110;">é–‰ã˜ã‚‹</button>
    </div>

</main>

<footer class="app-footer">
    ãƒ†ã‚¹ãƒˆç‰ˆï¼ˆãƒ™ãƒ¼ã‚¿ç‰ˆï¼‰ SP
</footer>

<!-- Fullscreen Overlay -->
<div id="fullscreen-preview" class="fullscreen-overlay">
    <iframe id="fullscreen-frame"></iframe>
    <button id="btn-exit-fullscreen" class="btn-floating-close">
        âœ• é–‰ã˜ã‚‹
    </button>
</div>

<!-- Modals -->
<div class="modal-overlay" id="modal-settings">
    <div class="modal-box">
        <div class="modal-header">
            <span>âš™ï¸ è¨­å®š</span>
            <button class="btn-icon modal-close">âœ•</button>
        </div>
        <div class="modal-body">
            <!-- Company Info Section -->
            <div style="margin-bottom:24px;">
                <h4 style="margin:0 0 12px 0; color:var(--ui-accent);">ğŸ¢ ä¼šç¤¾æƒ…å ±</h4>
                <div class="compact-grid">
                    <div class="input-row">
                        <label class="label-sm">ä¼šç¤¾åãƒ»å±‹å·</label>
                        <input type="text" id="inp-company" class="input-sm" placeholder="ä¾‹ï¼šå‰ç”°ç²¾å·¥æ ªå¼ä¼šç¤¾">
                    </div>
                    <div class="input-row">
                        <label class="label-sm">ä½æ‰€</label>
                        <input type="text" id="inp-address" class="input-sm" placeholder="ä¾‹ï¼šå¤§é˜ªåºœæ±å¤§é˜ªå¸‚...">
                    </div>
                    <div class="input-row">
                        <label class="label-sm">Googleãƒãƒƒãƒ—URL</label>
                        <input type="text" id="inp-map" class="input-sm" placeholder="https://goo.gl/maps/...">
                    </div>
                </div>
            </div>

            <!-- Contact Section -->
            <div style="margin-bottom:24px;">
                <h4 style="margin:0 0 12px 0; color:var(--ui-accent);">âœ‰ï¸ é€£çµ¡å…ˆãƒ»SNS</h4>
                <div class="compact-grid">
                    <div class="input-row">
                        <label class="label-sm">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="inp-email" class="input-sm" placeholder="info@example.com">
                    </div>
                    <div class="input-row">
                        <label class="label-sm">LINE URL</label>
                        <input type="text" id="inp-line" class="input-sm" placeholder="https://line.me/...">
                    </div>
                    <div class="input-row">
                        <label class="label-sm">Instagram URL</label>
                        <input type="text" id="inp-insta" class="input-sm" placeholder="https://instagram.com/...">
                    </div>
                </div>
            </div>

            <!-- App Settings -->
            <div style="margin-bottom:24px;">
                <h4 style="margin:0 0 12px 0; color:var(--ui-accent);">ğŸ¨ ã‚¢ãƒ—ãƒªè¨­å®š</h4>
                <div class="input-row">
                    <label class="label-sm">ç”»é¢ãƒ†ãƒ¼ãƒ</label>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-ghost theme-toggle active" data-val="light" style="flex:1">â˜€ï¸ Light</button>
                        <button class="btn btn-ghost theme-toggle" data-val="dark" style="flex:1">ğŸŒ™ Dark</button>
                    </div>
                </div>
            </div>

            <hr style="border:none; border-top:1px dashed var(--ui-border); margin:20px 0;">
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button id="btn-demo-manufacturing" class="btn-ghost" style="justify-content:flex-start;">ğŸ­ ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ï¼ˆè£½é€ æ¥­ï¼‰</button>
                <button id="btn-data-clear" class="btn-ghost" style="justify-content:flex-start; color:var(--ui-danger);">ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost modal-close">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-guide">
    <div class="modal-box">
        <div class="modal-header">
            <span>ğŸ”° ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</span>
            <button class="btn-icon modal-close">âœ•</button>
        </div>
        <div class="modal-body" style="line-height:1.8; font-size:0.95rem;">
            <p style="text-align:center; margin-bottom:24px; font-weight:bold; color:var(--ui-primary);">
                å†™çœŸã‚’é¸ã¶ã ã‘ã§ã€<br>ãƒ—ãƒ­ç´šã®ã‚µã‚¤ãƒˆãŒç§’é€Ÿã§å®Œæˆã—ã¾ã™ï¼
            </p>
            <ol style="padding-left:20px; display:flex; flex-direction:column; gap:16px;">
                <li>
                    <strong>æ¥­ç¨®ã‚’é¸ã¶</strong><br>
                    <span style="font-size:0.85rem; color:var(--ui-text-muted);">æ¥­ç¨®ã‚’é¸ã¶ã¨ã€ãƒ—ãƒ­ãŒä½œæˆã—ãŸæ–‡ç« ãŒè‡ªå‹•ã§ã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚ä¼šç¤¾åãªã©ã¯å³ä¸Šã®ã€Œâš™ï¸è¨­å®šã€ã‹ã‚‰å…¥åŠ›ã§ãã¾ã™ã€‚</span>
                </li>
                <li>
                    <strong>å†™çœŸã‚’4æšé¸ã¶</strong><br>
                    <span style="font-size:0.85rem; color:var(--ui-text-muted);">æ ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€ã‚¹ãƒãƒ›ã«å…¥ã£ã¦ã„ã‚‹å†™çœŸã‚’é¸ã‚“ã§ãã ã•ã„ã€‚ã€Œãƒ¡ã‚¤ãƒ³å†™çœŸã€1æšã¨ã€ã€Œä»•äº‹ã®æ§˜å­ã€ãªã©ã®å†™çœŸ3æšã§å®Œæˆã—ã¾ã™ã€‚</span>
                </li>
                <li>
                    <strong>ãŠå®¢æ§˜ã«è¦‹ã›ã‚‹ãƒ»é€ã‚‹</strong><br>
                    <span style="font-size:0.85rem; color:var(--ui-text-muted);">
                        ã€Œå…¨ç”»é¢ã§è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ã°ã€ãã®å ´ã§å…¨ç”»é¢è¡¨ç¤ºã§ãã¾ã™ã€‚<br>
                        ã€Œæ›¸ãå‡ºã—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã‚‹ã®ã§ã€ãã‚Œã‚’ãƒ¡ãƒ¼ãƒ«ç­‰ã§é€ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
                    </span>
                </li>
            </ol>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary modal-close">ã¯ã˜ã‚ã‚‹</button>
        </div>
    </div>
</div>

<div class="toast" id="toast">ä¿å­˜ã—ã¾ã—ãŸ</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- Config ---
    const colors = [
        { hex: '#020562', name: 'Navy' },
        { hex: '#22AEC9', name: 'Cyan' },
        { hex: '#10B981', name: 'Green' },
        { hex: '#F59E0B', name: 'Orange' },
        { hex: '#EC4899', name: 'Pink' }
    ];

    const templates = {
        manufacturing: {
            hintHero: "å·¥å ´ã®å…¨æ™¯ã€ã¾ãŸã¯ä¸»åŠ›è£½å“",
            catch: "æ—¥æœ¬ã®ã‚‚ã®ã¥ãã‚Šã‚’ã€\nä¸–ç•Œã¸å±Šã‘ã‚‹æŠ€è¡“åŠ›ã€‚",
            points: [
                {t: "çŸ­ç´æœŸå¯¾å¿œ", d: "24æ™‚é–“ç¨¼åƒä½“åˆ¶ã§æ€¥ãªã”ä¾é ¼ã«ã‚‚å¯¾å¿œã€‚"},
                {t: "ãƒŸã‚¯ãƒ­ãƒ³å˜ä½ã®ç²¾åº¦", d: "æœ€æ–°è¨­å‚™ã¨ç†Ÿç·´ã®æŠ€ã§é«˜ç²¾åº¦åŠ å·¥ã‚’å®Ÿç¾ã€‚"},
                {t: "è©¦ä½œã‹ã‚‰é‡ç”£ã¾ã§", d: "1å€‹ã®è©¦ä½œã‹ã‚‰é‡ç”£ã¾ã§ä¸€è²«å¯¾å¿œå¯èƒ½ã§ã™ã€‚"}
            ],
            cta: "å›³é¢è¦‹ç©ã‚‚ã‚Šã‚’ä¾é ¼"
        },
        wholesale: {
            hintHero: "å€‰åº«ã®æ§˜å­ã€ã¾ãŸã¯ãƒˆãƒ©ãƒƒã‚¯",
            catch: "ç‰©æµã®æœ€é©åŒ–ã§ã€\nãƒ“ã‚¸ãƒã‚¹ã‚’åŠ é€Ÿã•ã›ã‚‹ã€‚",
            points: [
                {t: "åœ§å€’çš„ãªåœ¨åº«åŠ›", d: "å¸¸æ™‚1ä¸‡ç‚¹ä»¥ä¸Šã‚’åœ¨åº«ã—æ¬ å“ã‚’é˜²ãã¾ã™ã€‚"},
                {t: "å³æ—¥é…é€", d: "14æ™‚ã¾ã§ã®æ³¨æ–‡ã¯å½“æ—¥å‡ºè·å¯èƒ½ã§ã™ã€‚"},
                {t: "å°ãƒ­ãƒƒãƒˆå¯¾å¿œ", d: "1å€‹ã‹ã‚‰ã®ç™ºæ³¨ã«ã‚‚æŸ”è»Ÿã«å¯¾å¿œã—ã¾ã™ã€‚"}
            ],
            cta: "åœ¨åº«ãƒ»æ›ç‡ã‚’ç¢ºèªã™ã‚‹"
        },
        insurance: {
            hintHero: "ç›¸è«‡é¢¨æ™¯ã€ã¾ãŸã¯ã‚ªãƒ•ã‚£ã‚¹",
            catch: "æœªæ¥ã®å®‰å¿ƒã‚’ã€\nã‚ãªãŸã¨ä¸€ç·’ã«è¨­è¨ˆã—ã¾ã™ã€‚",
            points: [
                {t: "ã‚ªãƒ¼ãƒ€ãƒ¼ãƒ¡ã‚¤ãƒ‰ææ¡ˆ", d: "ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ã«åˆã‚ã›ãŸæœ€é©ä¿é™ºã‚’è¨­è¨ˆã€‚"},
                {t: "ç›¸è«‡ä½•åº¦ã§ã‚‚ç„¡æ–™", d: "ç´å¾—ã„ãã¾ã§ã”ç›¸è«‡ã€‚ç„¡ç†ãªå‹§èª˜ã¯ãªã—ã€‚"},
                {t: "ä¸‡å…¨ã®ã‚µãƒãƒ¼ãƒˆ", d: "ä¸‡ãŒä¸€ã®éš›ã‚‚è¿…é€Ÿãƒ»è¦ªèº«ã«å¯¾å¿œã—ã¾ã™ã€‚"}
            ],
            cta: "ç„¡æ–™ç›¸è«‡ã‚’äºˆç´„ã™ã‚‹"
        },
        renovation: {
            hintHero: "æ–½å·¥å¾Œã®ç¶ºéº—ãªéƒ¨å±‹ã€å¤–è¦³",
            catch: "ç†æƒ³ã®ä½ã¾ã„ã‚’ã€\nç¢ºã‹ãªæŠ€è¡“ã§å½¢ã«ã—ã¾ã™ã€‚",
            points: [
                {t: "å®Œå…¨è‡ªç¤¾æ–½å·¥", d: "ä¸­é–“ãƒãƒ¼ã‚¸ãƒ³ãªã—ã®é©æ­£ä¾¡æ ¼ã§é«˜å“è³ªã€‚"},
                {t: "åœ°åŸŸå¯†ç€", d: "å›°ã£ãŸã¨ãã«ã™ãé§†ã‘ã¤ã‘ã¾ã™ã€‚"},
                {t: "ãƒ—ãƒ­ã®ææ¡ˆåŠ›", d: "ç”Ÿæ´»ã‚¹ã‚¿ã‚¤ãƒ«ã«åˆã‚ã›ãŸãƒ—ãƒ©ãƒ³ã‚’ã”ææ¡ˆã€‚"}
            ],
            cta: "ç„¡æ–™è¦‹ç©ã‚‚ã‚Šã‚’ä¾é ¼ã™ã‚‹"
        },
        pro: { 
            hintHero: "å…ˆç”Ÿã®ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆã€åŸ·å‹™é¢¨æ™¯",
            catch: "æ³•çš„èª²é¡Œã‚’è§£æ±ºã—ã€\näº‹æ¥­ã®æˆé•·ã‚’æ”¯æ´ã—ã¾ã™ã€‚",
            points: [
                {t: "è¿…é€Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹", d: "ãƒ“ã‚¸ãƒã‚¹ã‚’æ­¢ã‚ãªã„ç´ æ—©ã„å¯¾å¿œã€‚"},
                {t: "æ˜ç¢ºãªæ–™é‡‘ä½“ç³»", d: "äº‹å‰ã«è²»ç”¨ã‚’æç¤ºã—å®‰å¿ƒã‚’æä¾›ã€‚"},
                {t: "è±Šå¯Œãªè§£æ±ºå®Ÿç¸¾", d: "å¤šæ•°ã®äº‹ä¾‹ã«åŸºã¥ãæœ€é©è§£ã‚’ææ¡ˆã€‚"}
            ],
            cta: "åˆå›ç›¸è«‡ï¼ˆ60åˆ†ç„¡æ–™ï¼‰"
        },
        consulting: {
            hintHero: "ä¼šè­°é¢¨æ™¯ã€ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰",
            catch: "æˆ¦ç•¥ã¨å®Ÿè¡Œã§ã€\nä¼æ¥­ã®å£ã‚’çªç ´ã™ã‚‹ã€‚",
            points: [
                {t: "å®Ÿæˆ¦çš„æˆ¦ç•¥", d: "ç¾å ´ã§ä½¿ãˆã‚‹å…·ä½“çš„ãªæˆ¦ç•¥ã‚’ã”ææ¡ˆã€‚"},
                {t: "ãƒãƒ³ã‚ºã‚ªãƒ³æ”¯æ´", d: "ç¤¾å†…ã«å…¥ã‚Šè¾¼ã¿èª²é¡Œè§£æ±ºã«å–ã‚Šçµ„ã¿ã¾ã™ã€‚"},
                {t: "æˆæœã‚³ãƒŸãƒƒãƒˆ", d: "å£²ä¸Šã‚¢ãƒƒãƒ—ç­‰ã®çµæœã«ã“ã ã‚ã‚Šã¾ã™ã€‚"}
            ],
            cta: "ç„¡æ–™çµŒå–¶è¨ºæ–­ã‚’å—ã‘ã‚‹"
        },
        clinic: {
            hintHero: "æ¸…æ½”ãªå—ä»˜ã€ã¾ãŸã¯æ–½è¡“å®¤",
            catch: "åœ°åŸŸã®çš†æ§˜ã®\nå¥åº·ã¨ç¬‘é¡”ã‚’å®ˆã‚Šã¾ã™ã€‚",
            points: [
                {t: "ç—›ããªã„æ–½è¡“", d: "æœ€æ–°æ©Ÿå™¨ã§èº«ä½“ã«è² æ‹…ã®å°‘ãªã„æ²»ç™‚ã€‚"},
                {t: "ä¸å¯§ãªèª¬æ˜", d: "ç—‡çŠ¶ã‚’ã—ã£ã‹ã‚Šèãç´å¾—ã®æ²»ç™‚ã‚’ã€‚"},
                {t: "åœŸæ—¥ã‚‚è¨ºç™‚", d: "å¹³æ—¥å¿™ã—ã„æ–¹ã§ã‚‚é€šã„ã‚„ã™ã„ä½“åˆ¶ã€‚"}
            ],
            cta: "WEBäºˆç´„ã¯ã“ã¡ã‚‰"
        },
        restaurant: {
            hintHero: "ç¾å‘³ã—ãã†ãªæ–™ç†ã€ã¾ãŸã¯è³‘ã‚ã†åº—å†…",
            catch: "æ—¬ã®é£Ÿæã¨ç©ºé–“ã§ã€\nè‡³ç¦ã®ã²ã¨ã¨ãã‚’ã€‚",
            points: [
                {t: "ã“ã ã‚ã‚Šã®é£Ÿæ", d: "æ¯æœå¸‚å ´ã§ä»•å…¥ã‚Œã‚‹æ–°é®®ãªé­šä»‹ã¨é‡èœã‚’ä½¿ç”¨ã€‚"},
                {t: "ãã¤ã‚ãã®ç©ºé–“", d: "å€‹å®¤å®Œå‚™ã€‚æ¥å¾…ã‚„è¨˜å¿µæ—¥ã«ã‚‚ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚"},
                {t: "å³é¸ã—ãŸãŠé…’", d: "æ–™ç†ã«åˆã†æ—¥æœ¬é…’ãƒ»ãƒ¯ã‚¤ãƒ³ã‚’å¤šæ•°å–ã‚Šæƒãˆã€‚"}
            ],
            cta: "å¸­ã‚’äºˆç´„ã™ã‚‹"
        },
        salon: {
            hintHero: "ã‚«ãƒƒãƒˆä¸­ã®æ§˜å­ã€ãŠã—ã‚ƒã‚Œãªåº—å†…",
            catch: "ã‚ãªãŸæœ¬æ¥ã®ç¾ã—ã•ã‚’ã€\næœ€å¤§é™ã«å¼•ãå‡ºã—ã¾ã™ã€‚",
            points: [
                {t: "ä¼¼åˆã‚ã›ã‚«ãƒƒãƒˆ", d: "éª¨æ ¼ã‚„é«ªè³ªã‚’è¦‹æ¥µã‚ã€æ¯æœæ‰±ã„ã‚„ã™ã„é«ªã¸ã€‚"},
                {t: "é«ªè³ªæ”¹å–„", d: "ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ¬ã‚¹ãªè–¬å‰¤ã§ã€èŠ¯ã‹ã‚‰è¼ãé«ªã¸å°ãã¾ã™ã€‚"},
                {t: "ç™’ã—ã®ã‚¹ãƒ‘", d: "ãƒ•ãƒ«ãƒ•ãƒ©ãƒƒãƒˆã®ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼å°ã§æ¥µä¸Šã®ãƒªãƒ©ãƒƒã‚¯ã‚¹ã‚’ã€‚"}
            ],
            cta: "WEBäºˆç´„ãƒ»ã‚¯ãƒ¼ãƒãƒ³"
        }
    };

    // --- State ---
    const defaultState = {
        industry: 'manufacturing',
        themeColor: '#020562',
        company: '',
        catch: '',
        points: [
            {t:'', d:''}, {t:'', d:''}, {t:'', d:''}
        ],
        contact: { tel: '', hours: '' },
        images: { hero: null, p1: null, p2: null, p3: null },
        details: { address: '', map: '', email: '', line: '', insta: '' }
    };
    let state = JSON.parse(JSON.stringify(defaultState));
    let activeImgTarget = null; // 'hero', 'p1', ...

    // --- Persistence (LocalStorage) ---
    function saveState() {
        try {
            localStorage.setItem('hp_maker_v2', JSON.stringify(state));
        } catch(e) {
            console.error('Save failed (likely quota)', e);
        }
    }

    function loadState() {
        const saved = localStorage.getItem('hp_maker_v2');
        if(saved) {
            try {
                const parsed = JSON.parse(saved);
                state = { ...defaultState, ...parsed }; // Merge
                if(!state.details) state.details = defaultState.details; // Compat
                updateUI();
                showToast('å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
                return true;
            } catch(e) {
                console.error('Load failed', e);
            }
        }
        return false;
    }

    // --- Init UI ---
    
    // Render Color Pills
    const pillContainer = document.getElementById('color-pills');
    colors.forEach(c => {
        const d = document.createElement('div');
        d.className = 'color-pill';
        d.style.setProperty('--bg', c.hex);
        d.dataset.color = c.hex;
        d.onclick = () => {
            state.themeColor = c.hex;
            updateUI();
            saveState();
        };
        pillContainer.appendChild(d);
    });

    // --- DOM Elements ---
    const els = {
        selIndustry: document.getElementById('sel-industry'),
        inpCompany: document.getElementById('inp-company'),
        fileInput: document.getElementById('file-input'),
        textInputs: {
            catch: document.getElementById('inp-catch'),
            tel: document.getElementById('inp-tel'),
            hours: document.getElementById('inp-hours'),
            p1t: document.getElementById('inp-p1-t'), p1d: document.getElementById('inp-p1-d'),
            p2t: document.getElementById('inp-p2-t'), p2d: document.getElementById('inp-p2-d'),
            p3t: document.getElementById('inp-p3-t'), p3d: document.getElementById('inp-p3-d'),
        },
        // Details Inputs
        detailInputs: {
            address: document.getElementById('inp-address'),
            map: document.getElementById('inp-map'),
            email: document.getElementById('inp-email'),
            line: document.getElementById('inp-line'),
            insta: document.getElementById('inp-insta')
        },
        previewFrame: document.getElementById('preview-frame'),
        badgeSettings: document.getElementById('badge-settings')
    };

    // --- Functions ---

    function updateUI() {
        // Sync Inputs
        els.selIndustry.value = state.industry;
        els.inpCompany.value = state.company;
        
        // Sync Text Inputs (Advanced)
        els.textInputs.catch.value = state.catch;
        els.textInputs.tel.value = state.contact.tel;
        els.textInputs.hours.value = state.contact.hours;
        
        els.textInputs.p1t.value = state.points[0].t; els.textInputs.p1d.value = state.points[0].d;
        els.textInputs.p2t.value = state.points[1].t; els.textInputs.p2d.value = state.points[1].d;
        els.textInputs.p3t.value = state.points[2].t; els.textInputs.p3d.value = state.points[2].d;

        // Sync Details
        els.detailInputs.address.value = state.details.address;
        els.detailInputs.map.value = state.details.map;
        els.detailInputs.email.value = state.details.email;
        els.detailInputs.line.value = state.details.line;
        els.detailInputs.insta.value = state.details.insta;

        // Sync Color Pills
        document.querySelectorAll('.color-pill').forEach(p => {
            p.classList.toggle('active', p.dataset.color === state.themeColor);
        });

        // Sync Images
        ['hero', 'p1', 'p2', 'p3'].forEach(k => {
            const card = document.getElementById(`card-${k}`);
            const img = document.getElementById(`img-${k}`);
            if(state.images[k]) {
                card.classList.add('has-image');
                img.src = state.images[k];
            } else {
                card.classList.remove('has-image');
                img.src = '';
            }
        });

        // Update Labels & Hints in Photo Cards
        document.getElementById('lbl-p1').textContent = state.points[0].t || 'è©³ç´°æœªè¨­å®š';
        document.getElementById('lbl-p2').textContent = state.points[1].t || 'è©³ç´°æœªè¨­å®š';
        document.getElementById('lbl-p3').textContent = state.points[2].t || 'è©³ç´°æœªè¨­å®š';
        
        const currentTmpl = templates[state.industry];
        if(currentTmpl && currentTmpl.hintHero) {
            document.getElementById('hint-hero').textContent = currentTmpl.hintHero;
        }

        // Badge Check (Simple Validation)
        if(!state.company) {
            els.badgeSettings.classList.add('active');
        } else {
            els.badgeSettings.classList.remove('active');
        }

        renderPreview();
    }

    function loadIndustryTemplate(ind) {
        const t = templates[ind];
        if(!t) return;
        state.catch = t.catch;
        state.points = JSON.parse(JSON.stringify(t.points));
        // Contact info defaults? maybe empty is better
        updateUI();
        saveState();
    }

    function generateHtmlContent() {
        const c = state.themeColor;
        const bgLight = adjustColorOpacity(c, 0.05);

        // Hero Background
        const heroStyle = state.images.hero 
            ? `background-image: linear-gradient(rgba(0,0,0,0.3),rgba(0,0,0,0.3)), url(${state.images.hero});`
            : `background: linear-gradient(135deg, ${c}, #0f172a);`;

        // Points HTML
        const pointsHtml = state.points.map((p, i) => {
            const imgKey = `p${i+1}`;
            const imgHtml = state.images[imgKey] 
                ? `<div style="height:200px; background:url(${state.images[imgKey]}) center/cover;"></div>` 
                : `<div style="height:200px; background:${bgLight}; display:flex; align-items:center; justify-content:center; color:#999;">NO IMAGE</div>`;
            return `
            <div class="card scroll-anim">
                ${imgHtml}
                <div style="padding:24px;">
                    <h3 style="font-size:1.2rem; margin-bottom:10px;">${safe(p.t)}</h3>
                    <p style="font-size:0.95rem; opacity:0.8;">${safe(p.d)}</p>
                </div>
            </div>`;
        }).join('');

        // Details Links
        const d = state.details;
        let snsLinks = '';
        if(d.insta) snsLinks += `<a href="${safe(d.insta)}" target="_blank" style="display:inline-block;margin:5px;padding:10px 16px;background:#E1306C;color:white;border-radius:50px;font-size:0.9rem;text-decoration:none;font-weight:bold;">Instagram</a>`;
        if(d.line) snsLinks += `<a href="${safe(d.line)}" target="_blank" style="display:inline-block;margin:5px;padding:10px 16px;background:#06C755;color:white;border-radius:50px;font-size:0.9rem;text-decoration:none;font-weight:bold;">LINEå…¬å¼</a>`;
        
        let mapLink = '';
        if(d.map && d.address) mapLink = `<a href="${safe(d.map)}" target="_blank" style="text-decoration:underline;color:var(--p); margin-left:8px;">[åœ°å›³ã‚’è¦‹ã‚‹]</a>`;

        return `
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${safe(state.company)}</title>
<style>
    :root { --p: ${c}; --bg: ${bgLight}; }
    body{margin:0;font-family:"Helvetica Neue",Arial,sans-serif;color:#333;line-height:1.8;background:#f9f9f9;}
    a{text-decoration:none;transition:opacity 0.3s;} a:hover{opacity:0.8;}
    
    /* Header */
    header{padding:15px 5%;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 15px rgba(0,0,0,0.05);position:sticky;top:0;background:rgba(255,255,255,0.95);backdrop-filter:blur(5px);z-index:100;}
    .logo{font-weight:bold;font-size:1.1rem;color:var(--p);}
    .tel{background:var(--p);color:#fff;padding:8px 16px;border-radius:50px;font-weight:bold;font-size:0.85rem;}
    
    /* Hero */
    .hero{height:80vh;min-height:400px;display:flex;align-items:center;justify-content:center;text-align:center;color:#fff;background-size:cover;background-position:center;padding:20px; ${heroStyle} animation: fadeIn 1.5s ease;}
    .hero h1{font-size:clamp(1.5rem, 5vw, 2.8rem);text-shadow:0 4px 10px rgba(0,0,0,0.6);white-space:pre-wrap;line-height:1.4; letter-spacing:0.05em;}
    
    /* Section */
    section{padding:80px 5%;}
    h2{text-align:center;color:var(--p);font-size:1.8rem;margin-bottom:60px;position:relative;display:inline-block;}
    h2::after{content:'';display:block;width:60px;height:3px;background:var(--p);margin:15px auto 0;}
    .center-h2{text-align:center;}
    
    /* Cards */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:40px;max-width:1100px;margin:0 auto;}
    .card{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.05);transition:transform 0.3s ease;}
    .card:hover{transform:translateY(-5px);}
    .card h3{color:var(--p);margin:0;}
    
    /* Footer & Contact */
    .contact-area{background:var(--bg); text-align:center; padding: 100px 20px;}
    .footer{background:#1e293b;color:#fff;text-align:center;padding:50px 20px;font-size:0.9rem;}
    
    /* Animations */
    @keyframes fadeIn { from{opacity:0;transform:scale(1.05);} to{opacity:1;transform:scale(1);} }
    .scroll-anim { opacity: 0; transform: translateY(30px); transition: all 0.8s ease; }
    .scroll-anim.visible { opacity: 1; transform: translateY(0); }
    
    @media(max-width:600px){ .hero{height:500px;} section{padding:60px 5%;} }
</style>
<script>
    // Simple Scroll Animation Script
    document.addEventListener('DOMContentLoaded', () => {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if(entry.isIntersecting){
                    entry.target.classList.add('visible');
                }
            });
        }, { threshold: 0.1 });
        document.querySelectorAll('.scroll-anim').forEach(el => observer.observe(el));
    });
<\/script>
</head>
<body>
    <header>
        <div class="logo">${safe(state.company)||'COMPANY'}</div>
        ${state.contact.tel ? `<a href="tel:${state.contact.tel}" class="tel">ğŸ“ ${state.contact.tel}</a>` : ''}
    </header>
    
    <div class="hero">
        <h1>${safe(state.catch) || 'ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼'}</h1>
    </div>
    
    <section>
        <div class="center-h2"><h2 class="scroll-anim">é¸ã°ã‚Œã‚‹ç†ç”±</h2></div>
        <div class="grid">${pointsHtml}</div>
    </section>
    
    <section class="contact-area">
        <div class="center-h2"><h2 class="scroll-anim">ãŠå•ã„åˆã‚ã›</h2></div>
        <p class="scroll-anim" style="margin-bottom:30px;">ãŠæ°—è»½ã«ã”ç›¸è«‡ãã ã•ã„ã€‚<br>${safe(state.contact.hours)}</p>
        
        ${state.contact.tel ? `<div class="scroll-anim" style="font-size:2rem;font-weight:bold;color:var(--p);margin-bottom:20px;">${state.contact.tel}</div>` : ''}
        
        ${d.email ? `<p class="scroll-anim">Email: <a href="mailto:${safe(d.email)}" style="color:var(--p);">${safe(d.email)}</a></p>` : ''}
        
        <div class="scroll-anim" style="margin-top:40px;">${snsLinks}</div>
    </section>

    <div class="footer">
        <p style="font-weight:bold; font-size:1.2rem; margin-bottom:15px;">${safe(state.company)}</p>
        ${d.address ? `<p>${safe(d.address)} ${mapLink}</p>` : ''}
        <p style="opacity:0.6; margin-top:40px; font-size:0.75rem;">&copy; ${safe(state.company)}</p>
    </div>
</body>
</html>`;
    }

    function renderPreview() {
        els.previewFrame.srcdoc = generateHtmlContent();
    }

    // --- Events ---

    // 1. Inputs Change
    els.selIndustry.addEventListener('change', (e) => {
        state.industry = e.target.value;
        loadIndustryTemplate(state.industry);
    });
    els.inpCompany.addEventListener('input', (e) => { 
        state.company = e.target.value; 
        updateUI(); 
        saveState();
    });
    
    // Details Inputs
    Object.keys(els.detailInputs).forEach(key => {
        els.detailInputs[key].addEventListener('input', (e) => {
            state.details[key] = e.target.value;
            renderPreview();
            saveState();
        });
    });
    
    // Advanced Text Change
    els.textInputs.catch.addEventListener('input', (e)=>{ state.catch=e.target.value; renderPreview(); saveState(); });
    els.textInputs.tel.addEventListener('input', (e)=>{ state.contact.tel=e.target.value; renderPreview(); saveState(); });
    els.textInputs.hours.addEventListener('input', (e)=>{ state.contact.hours=e.target.value; renderPreview(); saveState(); });
    
    // Point Text Change
    ['p1','p2','p3'].forEach((k, i) => {
        els.textInputs[`${k}t`].addEventListener('input', (e)=>{ state.points[i].t=e.target.value; updateUI(); saveState(); });
        els.textInputs[`${k}d`].addEventListener('input', (e)=>{ state.points[i].d=e.target.value; updateUI(); saveState(); });
    });

    // 2. Photo Deck Interaction
    document.querySelectorAll('.photo-card').forEach(card => {
        card.addEventListener('click', (e) => {
            if(e.target.classList.contains('btn-photo-clear')) return; // handled separately
            activeImgTarget = card.dataset.target;
            els.fileInput.click();
        });
    });

    // --- Image Handling with Resize ---
    els.fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file || !activeImgTarget) return;
        
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_WIDTH = 800;
                const MAX_HEIGHT = 800;
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                } else {
                    if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                }

                canvas.width = width; canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                state.images[activeImgTarget] = dataUrl;
                updateUI();
                saveState();
                showToast('å†™çœŸã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
        e.target.value = ''; // Reset
    });

    document.querySelectorAll('.btn-photo-clear').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const t = btn.dataset.target;
            state.images[t] = null;
            updateUI();
            saveState();
        });
    });

    // 3. Text Edit Toggle
    document.getElementById('btn-toggle-text').addEventListener('click', () => {
        document.getElementById('text-edit-section').classList.toggle('open');
    });

    // 4. Modals & Settings
    document.getElementById('btn-settings').addEventListener('click', () => {
        document.getElementById('modal-settings').classList.add('active');
    });
    document.getElementById('btn-guide').addEventListener('click', () => {
        document.getElementById('modal-guide').classList.add('active');
    });
    document.querySelectorAll('.modal-close').forEach(b => {
        b.addEventListener('click', (e) => e.target.closest('.modal-overlay').classList.remove('active'));
    });

    // 5. Fullscreen Preview
    const fsOverlay = document.getElementById('fullscreen-preview');
    const fsFrame = document.getElementById('fullscreen-frame');
    
    document.getElementById('btn-fullscreen').addEventListener('click', () => {
        // Load content into fullscreen iframe
        fsFrame.srcdoc = generateHtmlContent();
        fsOverlay.classList.add('active');
    });
    
    document.getElementById('btn-exit-fullscreen').addEventListener('click', () => {
        fsOverlay.classList.remove('active');
    });

    // Demo Data
    document.getElementById('btn-demo-manufacturing').addEventListener('click', () => {
        state.industry = 'manufacturing';
        state.company = 'å‰ç”°ç²¾å·¥æ ªå¼ä¼šç¤¾';
        state.themeColor = '#020562';
        state.contact.tel = '03-1234-5678';
        state.contact.hours = '9:00ã€œ18:00';
        // Add Demo Details
        state.details.address = 'å¤§é˜ªåºœæ±å¤§é˜ªå¸‚æœ¬åº„è¥¿1-2-3';
        state.details.email = 'info@maeda-seiko.demo';
        state.details.map = 'https://goo.gl/maps/dummy';
        state.details.line = 'https://line.me/R/ti/p/dummy';
        state.details.insta = 'https://instagram.com/dummy';
        
        loadIndustryTemplate('manufacturing');
        document.getElementById('modal-settings').classList.remove('active');
        showToast('ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã—ã¾ã—ãŸ');
    });

    document.getElementById('btn-data-clear').addEventListener('click', () => {
        if(confirm('å…¥åŠ›ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
            localStorage.removeItem('hp_maker_v2');
            state = JSON.parse(JSON.stringify(defaultState));
            updateUI();
            document.getElementById('modal-settings').classList.remove('active');
            showToast('ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }
    });

    // Theme Toggle
    document.querySelectorAll('.theme-toggle').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const mode = e.target.dataset.val;
            document.documentElement.setAttribute('data-theme', mode);
            document.querySelectorAll('.theme-toggle').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
        });
    });

    // Preview Mobile/PC
    document.querySelectorAll('.device-btn').forEach(btn => {
        if(btn.id === 'btn-fullscreen') return; // skip fs btn
        btn.addEventListener('click', () => {
            document.querySelectorAll('.device-btn').forEach(b => {
                if(b.id !== 'btn-fullscreen') b.classList.remove('active');
            });
            btn.classList.add('active');
            const wrapper = document.getElementById('preview-wrapper');
            wrapper.className = `preview-frame-wrapper mode-${btn.dataset.mode.toLowerCase()}`;
        });
    });
    
    // Mobile Preview Panel Toggle
    if(window.innerWidth <= 768) {
        const previewPanel = document.getElementById('preview-panel');
        const mobileToggle = document.createElement('button');
        mobileToggle.className = 'btn btn-ghost';
        mobileToggle.innerHTML = 'ğŸ‘ï¸';
        mobileToggle.onclick = () => previewPanel.classList.add('active');
        document.querySelector('.app-actions').prepend(mobileToggle);
        
        document.getElementById('btn-close-preview').addEventListener('click', () => {
            previewPanel.classList.remove('active');
        });
    }

    // Export
    document.getElementById('btn-export-html').addEventListener('click', () => {
        if(!state.company) { alert('ä¼šç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        const content = generateHtmlContent(); // Use the generator
        const blob = new Blob([content], {type:'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${state.company}_website.html`;
        a.click();
    });

    // Helper
    function safe(s) { return s ? s.replace(/[<>&"]/g, c=>({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c])) : ''; }
    function adjustColorOpacity(hex, alpha) {
        let r=0,g=0,b=0;
        if(hex.length===4){r=parseInt(hex[1]+hex[1],16);g=parseInt(hex[2]+hex[2],16);b=parseInt(hex[3]+hex[3],16);}
        else{r=parseInt(hex[1]+hex[2],16);g=parseInt(hex[3]+hex[4],16);b=parseInt(hex[5]+hex[6],16);}
        return `rgba(${r},${g},${b},${alpha})`;
    }
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.classList.add('active');
        setTimeout(()=>t.classList.remove('active'), 2500);
    }

    // Init
    if(!loadState()) {
        loadIndustryTemplate('manufacturing');
    }

});
</script>
</body>
</html>